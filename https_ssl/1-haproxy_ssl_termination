#!/usr/bin/env bash
# File: 2-install_ssl_haproxy
# Installs HAProxy, obtains an SSL certificate for www.ruthqueen.tech using Certbot,
# and configures HAProxy for SSL termination on port 443.

# --- Configuration Variables (REPLACE with your actual IPs) ---
WEB_01_IP="52.90.187.27"
WEB_02_IP="52.87.176.209"
DOMAIN="www.ruthqueen.tech"
CERT_PATH="/etc/letsencrypt/live/$DOMAIN"
PEM_FILE="/etc/haproxy/ssl/$DOMAIN.pem"
HAPROXY_CONF="/etc/haproxy/haproxy.cfg"

# --- 1. Installation ---
echo "--> Updating package lists and installing HAProxy and Certbot..."
sudo apt-get update -y
# Install HAProxy (which should default to v1.5+ on modern Ubuntu) and Certbot
sudo apt-get install -y haproxy certbot

# --- 2. Certificate Acquisition (Certbot) ---

echo "--> Stopping HAProxy to allow Certbot to use port 80..."
# Stop HAProxy so Certbot can run its temporary web server for domain verification
sudo systemctl stop haproxy

echo "--> Obtaining SSL certificate for $DOMAIN using certbot..."
# Use --standalone mode to run a temporary web server
if ! sudo certbot certonly --standalone -d "$DOMAIN" --agree-tos -n -m sysadmin@ruthqueen.tech; then
    echo "ERROR: Certbot failed to obtain the certificate. Check logs for details."
    exit 1
fi

echo "--> Combining fullchain.pem and privkey.pem into a single $DOMAIN.pem file..."
# HAProxy requires the full certificate chain and private key in one .pem file
sudo mkdir -p /etc/haproxy/ssl/
sudo sh -c "cat $CERT_PATH/fullchain.pem $CERT_PATH/privkey.pem > $PEM_FILE"
sudo chmod 600 "$PEM_FILE"

# --- 3. Configuration ---

echo "--> Creating HAProxy configuration file: $HAPROXY_CONF"
sudo tee "$HAPROXY_CONF" > /dev/null << EOF
# File: 1-haproxy_ssl_termination
# HAProxy configuration for SSL termination on port 443,
# forwarding decrypted traffic to web-01 and web-02 on port 80.

global
    log /dev/log    local0 notice
    # Set the maximum number of concurrent connections
    maxconn 2048
    # User/group to run as
    user haproxy
    group haproxy
    # Security setting: disable compression to mitigate BREACH attacks
    tune.ssl.default-dh-param 2048

defaults
    log global
    mode http
    option httplog
    option dontlognull
    timeout connect 5000ms
    timeout client 50000ms
    timeout server 50000ms
    # Recommended for high traffic
    retries 3

# -----------------
# FRONTEND - HTTP (Port 80)
# Redirects all incoming HTTP traffic to HTTPS
# -----------------
frontend http_front
    bind *:80
    mode http
    # If the user is NOT using SSL, redirect them to the HTTPS frontend
    redirect scheme https code 301

# -----------------
# FRONTEND - HTTPS (Port 443)
# Performs SSL Termination
# -----------------
frontend https_front
    # Binds to port 443, enabling SSL termination with the combined PEM file.
    # Note: Ensure the path to the PEM file is correct.
    bind *:443 ssl crt $PEM_FILE
    mode http
    default_backend web_servers

# -----------------
# BACKEND - Web Servers (Port 80)
# -----------------
backend web_servers
    mode http
    balance roundrobin
    
    # Define the Web Server instances
    server web-01 ${WEB_01_IP}:80 check
    server web-02 ${WEB_02_IP}:80 check
EOF

# --- 4. Validation and Restart ---
echo "--> Testing HAProxy configuration..."
CONFIG_CHECK_OUTPUT=$(sudo haproxy -c -f "$HAPROXY_CONF" 2>&1)
if [ $? -eq 0 ]; then
    echo "HAProxy configuration is valid. Starting/Restarting service..."
    sudo systemctl daemon-reload # Reload systemd configs if necessary
    sudo systemctl restart haproxy
    echo "HAProxy service started successfully."
    echo "You can now test HTTPS access: curl -sI https://$DOMAIN"
else
    echo "ERROR: HAProxy configuration failed validation."
    echo "--- Configuration Check Output ---"
    echo "$CONFIG_CHECK_OUTPUT"
    echo "----------------------------------"
    echo "Service was NOT restarted."
    exit 1
fi

echo "Script finished."
